<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Multimedia</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Lora:ital,wght@1,500&family=Montserrat:wght@600&family=Open+Sans:wght@600&family=Playfair+Display:wght@700&family=Roboto+Slab:wght@600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --border-color: #444;
            --drop-zone-bg: #252525;
            --drop-zone-hover: #333;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh; overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 360px; 
            grid-template-rows: 100%;
        }

        /* --- LEFT SIDE --- */
        .control-panel {
            padding: 25px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; gap: 20px;
            overflow-y: auto;
        }

        .dashboard-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            background: #333; padding: 20px; border-radius: 8px; border: 1px solid #444;
        }
        .dashboard-full {
            background: #333; padding: 20px; border-radius: 8px; border: 1px solid #444;
            display: flex; flex-direction: column; gap: 15px;
        }

        .section-header {
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold;
            color: var(--accent-color); margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 5px;
        }

        /* --- NEW DROP ZONE STYLES --- */
        .drop-zone {
            border: 2px dashed #666;
            border-radius: 8px;
            background-color: var(--drop-zone-bg);
            color: #aaa;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
            height: 140px; /* Tinggi fix untuk mengisi ruang */
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 10px;
        }
        
        .drop-zone:hover {
            border-color: var(--accent-color);
            background-color: var(--drop-zone-hover);
            color: white;
        }

        .drop-zone.dragover {
            border-color: var(--success-color);
            background-color: #2c3e50;
            transform: scale(1.02);
        }

        .drop-icon { font-size: 2rem; margin-bottom: 5px; color: var(--accent-color); }
        .drop-text { font-size: 0.85rem; font-weight: bold; }
        .drop-sub { font-size: 0.7rem; color: #777; margin-top: 3px; }

        /* Hidden file input */
        #bgFile { display: none; }

        /* --- Inputs --- */
        .input-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        label { font-size: 0.8rem; color: #aaa; }
        
        select, input[type="color"] {
            padding: 8px; background-color: #222; color: white;
            border: 1px solid var(--border-color); border-radius: 4px;
            font-size: 0.9rem; width: 100%; box-sizing: border-box;
        }
        input[type="color"] { padding: 0; height: 35px; cursor: pointer; }

        /* Navigation */
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .nav-buttons { display: grid; grid-template-columns: auto 1fr 1fr auto; gap: 10px; }

        button {
            padding: 12px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; color: white;
            transition: background 0.2s; font-size: 1rem;
        }

        .btn-proj { background-color: #9b59b6; width: 100%; padding: 15px; margin-bottom: 10px; }
        .btn-proj:hover { background-color: #8e44ad; }
        
        .btn-prev, .btn-next { background-color: var(--accent-color); font-size: 1.5rem; width: 60px; }
        .btn-show { background-color: var(--success-color); }
        .btn-hide { background-color: var(--danger-color); }
        .btn-cancel { background-color: #7f8c8d; font-size: 0.9rem; padding: 8px; }

        /* --- RIGHT SIDE --- */
        .right-sidebar {
            background-color: #222;
            border-left: 1px solid var(--border-color);
            padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            overflow-y: auto; 
        }

        .preview-label-title {
            color: #fff; font-size: 0.85rem; font-weight: bold; 
            text-align: center; border-bottom: 1px solid #444; padding-bottom: 5px;
        }

        .slide-wrapper {
            width: 100%; aspect-ratio: 16 / 9;
            background-color: black; position: relative; overflow: hidden;
            border: 2px solid #555; border-radius: 4px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .slide-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        
        .slide-content {
            position: relative; z-index: 2; 
            width: 60%; height: 60%;
            text-align: center; color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.9);
            display: none;
            flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Segoe UI', sans-serif;
        }
        .slide-ref { font-weight: 400; color: #f1c40f; font-size: 1.5rem; margin-bottom: 0.5rem; line-height: 1.2; }
        .slide-text { font-weight: 600; line-height: 1.3; font-size: 1.5rem; width: 100%; }

        .monitor-stack { display: flex; flex-direction: column; gap: 10px; flex-grow: 1; }

        .preview-box {
            background-color: #1a1a1a; padding: 12px; border-radius: 6px;
            border-left: 5px solid var(--border-color); 
            display: flex; flex-direction: column;
        }
        .preview-box.active { border-left-color: var(--success-color); background-color: #2c3e50; }
        .preview-box.prev { border-left-color: #7f8c8d; opacity: 0.7; }
        .preview-box.next { border-left-color: var(--accent-color); }

        .p-label { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 4px; font-weight: bold; }
        .p-ref { font-weight: bold; color: var(--accent-color); font-size: 1rem; margin-bottom: 5px; }
        .p-text { 
            font-style: italic; font-size: 0.85rem; line-height: 1.4; color: #ccc; 
            display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; 
        }

        .status-bar { color: #888; font-size: 0.75rem; text-align: center; margin-top: auto; padding-top:10px;}
        
        /* Loading overlay for DB */
        #dbLoading { color: var(--accent-color); font-style: italic; font-size: 0.8rem; margin-bottom: 10px; display:none;}

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes zoomOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(1.2); } }
        @keyframes slideUpIn { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDownOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(50px); } }
        @keyframes blurIn { from { opacity: 0; filter: blur(10px); } to { opacity: 1; filter: blur(0); } }
        @keyframes blurOut { from { opacity: 1; filter: blur(0); } to { opacity: 0; filter: blur(10px); } }

        .anim-fade-in { animation: fadeIn 0.8s ease forwards; }
        .anim-fade-out { animation: fadeOut 0.6s ease forwards; }
        .anim-zoom-in { animation: zoomIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .anim-zoom-out { animation: zoomOut 0.5s ease forwards; }
        .anim-slide-in { animation: slideUpIn 0.6s ease-out forwards; }
        .anim-slide-out { animation: slideDownOut 0.5s ease-in forwards; }
        .anim-blur-in { animation: blurIn 1s ease forwards; }
        .anim-blur-out { animation: blurOut 0.6s ease forwards; }
        .anim-none-in { animation: none; opacity: 1; }
        .anim-none-out { animation: none; opacity: 0; }
    </style>
</head>
<body>

    <div class="control-panel">
        <div class="dashboard-row">
            <div>
                <div class="section-header">1. Background & Assets</div>
                
                <div id="dbLoading">Mencari database_alkitab_v2.bin...</div>
                
                <div class="drop-zone" id="bgDropZone">
                    <div class="drop-icon">&#128444;</div>
                    <div class="drop-text">Klik, Drag & Drop, atau Paste (Ctrl+V)</div>
                    <div class="drop-sub">untuk mengganti background</div>
                    <input type="file" id="bgFile" accept="image/*">
                </div>
            </div>

            <div>
                <div class="section-header">2. Tampilan</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="input-group">
                        <label>Font:</label>
                        <select id="fontSelect">
                            <option value="'Segoe UI', sans-serif">Segoe UI</option>
                            <option value="'Roboto Slab', serif">Roboto Slab</option>
                            <option value="'Playfair Display', serif">Playfair</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="'Lora', serif">Lora</option>
                            <option value="'Cinzel', serif">Cinzel</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Warna Ayat:</label>
                        <input type="color" id="colorText" value="#ffffff" style="width:100%;">
                    </div>
                    <div class="input-group">
                        <label>Anim Masuk:</label>
                        <select id="animInSelect">
                            <option value="anim-fade-in">Fade In</option>
                            <option value="anim-zoom-in">Zoom In</option>
                            <option value="anim-slide-in">Slide Up</option>
                            <option value="anim-blur-in">Blur</option>
                            <option value="anim-none-in">None</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Warna Ref:</label>
                        <input type="color" id="colorRef" value="#f1c40f" style="width:100%;">
                    </div>
                    <div class="input-group">
                        <label>Anim Keluar:</label>
                        <select id="animOutSelect">
                            <option value="anim-fade-out">Fade Out</option>
                            <option value="anim-zoom-out">Zoom Out</option>
                            <option value="anim-slide-out">Slide Down</option>
                            <option value="anim-blur-out">Blur</option>
                            <option value="anim-none-out">None</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-full">
            <div class="section-header">3. Proyektor & Navigasi</div>
            
            <button id="btnOpenProj" class="btn-proj">&#128421; BUKA JENDELA PROYEKTOR (LAYAR 2)</button>

            <div class="nav-grid">
                <select id="bookSelect" disabled><option>Book</option></select>
                <select id="chapterSelect" disabled><option>Ch</option></select>
                <select id="verseSelect" disabled><option>Ver</option></select>
            </div>

            <div class="nav-buttons">
                <button id="btnPrev" class="btn-prev" title="Back">&#9664;</button>
                <button id="btnShow" class="btn-show">TAMPILKAN (LIVE)</button>
                <button id="btnHide" class="btn-hide">HILANGKAN</button>
                <button id="btnNext" class="btn-next" title="Next">&#9654;</button>
            </div>
            
            <button id="btnCancel" class="btn-cancel">Reset Pilihan ke Live Saat Ini</button>
        </div>
    </div>

    <div class="right-sidebar">
        <div>
            <div class="preview-label-title">PREVIEW OUTPUT</div>
            <div class="slide-wrapper" id="internalContainer">
                <img id="slide-bg" class="slide-bg" src="" alt="" style="display:none;">
                <div id="slide-content" class="slide-content">
                    <div id="slide-ref" class="slide-ref"></div>
                    <div id="slide-text" class="slide-text"></div>
                </div>
            </div>
        </div>

        <div class="preview-label-title" style="margin-top:10px;">MONITOR FLOW</div>
        <div class="monitor-stack">
            <div class="preview-box prev">
                <div class="p-label">Sebelumnya</div>
                <div id="prevRef" class="p-ref">-</div>
                <div id="prevText" class="p-text">...</div>
            </div>
            <div class="preview-box active">
                <div class="p-label">LIVE ON SCREEN</div>
                <div id="currRef" class="p-ref">-</div>
                <div id="currText" class="p-text">Siap...</div>
            </div>
            <div class="preview-box next">
                <div class="p-label">Selanjutnya</div>
                <div id="nextRef" class="p-ref">-</div>
                <div id="nextText" class="p-text">...</div>
            </div>
        </div>

        <div class="status-bar" id="statusBar">Menunggu Database...</div>
    </div>

    <script>
        let db = null;
        let flatBooks = []; 
        let liveState = { bookIdx: 0, chIdx: 0, vIdx: 0 }; 
        let selectedState = { bookIdx: 0, chIdx: 0, vIdx: 0 };
        let isLiveVisible = false;
        
        let projectorWindow = null;
        let bgImageUrl = "";

        const els = {
            bgFile: document.getElementById('bgFile'),
            dropZone: document.getElementById('bgDropZone'),
            dbLoading: document.getElementById('dbLoading'),
            
            fontSel: document.getElementById('fontSelect'),
            colorText: document.getElementById('colorText'),
            colorRef: document.getElementById('colorRef'),
            animInSel: document.getElementById('animInSelect'),
            animOutSel: document.getElementById('animOutSelect'),
            bookSel: document.getElementById('bookSelect'),
            chapSel: document.getElementById('chapterSelect'),
            verseSel: document.getElementById('verseSelect'),
            btnPrev: document.getElementById('btnPrev'),
            btnNext: document.getElementById('btnNext'),
            btnShow: document.getElementById('btnShow'),
            btnHide: document.getElementById('btnHide'),
            btnCancel: document.getElementById('btnCancel'),
            btnOpenProj: document.getElementById('btnOpenProj'),
            pPrevRef: document.getElementById('prevRef'),
            pPrevTxt: document.getElementById('prevText'),
            pCurrRef: document.getElementById('currRef'),
            pCurrTxt: document.getElementById('currText'),
            pNextRef: document.getElementById('nextRef'),
            pNextTxt: document.getElementById('nextText'),
            slideBg: document.getElementById('slide-bg'),
            slideContent: document.getElementById('slide-content'),
            slideText: document.getElementById('slide-text'),
            slideRef: document.getElementById('slide-ref'),
            internalContainer: document.getElementById('internalContainer'),
            statusBar: document.getElementById('statusBar')
        };

        // --- AUTO LOAD DATABASE ---
        window.addEventListener('DOMContentLoaded', () => {
            loadDatabase();
        });

        function loadDatabase() {
            els.dbLoading.style.display = 'block';
            // Try fetch database_alkitab_v2.bin
            fetch('database_alkitab_v2.bin')
                .then(response => {
                    if (!response.ok) throw new Error("File not found");
                    return response.json();
                })
                .then(json => {
                    processDatabase(json);
                    els.dbLoading.style.display = 'none';
                })
                .catch(err => {
                    // Fallback try .json if .bin fails
                    fetch('database_alkitab_v2.json')
                        .then(response => {
                            if (!response.ok) throw new Error("File not found");
                            return response.json();
                        })
                        .then(json => {
                            processDatabase(json);
                            els.dbLoading.style.display = 'none';
                        })
                        .catch(finalErr => {
                            els.dbLoading.textContent = "Gagal memuat otomatis. Pastikan file 'database_alkitab_v2.bin' ada di folder ini.";
                            els.dbLoading.style.color = "#e74c3c";
                        });
                });
        }

        // --- BACKGROUND LOGIC (Click, Drop, Paste) ---
        
        // 1. Click Handler
        els.dropZone.addEventListener('click', () => els.bgFile.click());
        els.bgFile.addEventListener('change', (e) => handleBgFile(e.target.files[0]));

        // 2. Drag & Drop Handlers
        els.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            els.dropZone.classList.add('dragover');
        });
        els.dropZone.addEventListener('dragleave', () => {
            els.dropZone.classList.remove('dragover');
        });
        els.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            els.dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleBgFile(e.dataTransfer.files[0]);
            }
        });

        // 3. Paste Handler (Global)
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile();
                    handleBgFile(blob);
                    // Visual feedback
                    els.dropZone.style.borderColor = "var(--success-color)";
                    setTimeout(() => els.dropZone.style.borderColor = "#666", 500);
                    break;
                }
            }
        });

        function handleBgFile(file) {
            if (file && file.type.startsWith('image/')) {
                bgImageUrl = URL.createObjectURL(file);
                
                // Update Internal
                els.slideBg.src = bgImageUrl;
                els.slideBg.style.display = 'block';
                
                // Update Projector if open
                if (projectorWindow && !projectorWindow.closed) {
                    const pBg = projectorWindow.document.getElementById('p-bg');
                    if (pBg) { pBg.src = bgImageUrl; pBg.style.display = 'block'; }
                }
                
                // Update Dropzone Text
                els.dropZone.querySelector('.drop-text').textContent = "Gambar Terpasang: " + (file.name || "Pasted Image");
            }
        }

        // --- STYLE UPDATE ---
        const updateStylesOnly = () => {
             const font = els.fontSel.value;
             const cText = els.colorText.value;
             const cRef = els.colorRef.value;

             els.slideContent.style.fontFamily = font;
             els.slideText.style.color = cText;
             els.slideRef.style.color = cRef;

             if(isLiveVisible) autoFitText(els.internalContainer, els.slideContent, els.slideText);

             if (projectorWindow && !projectorWindow.closed) {
                 const doc = projectorWindow.document;
                 const pContent = doc.getElementById('p-content');
                 const pText = doc.getElementById('p-text');
                 const pRef = doc.getElementById('p-ref');
                 
                 if (pContent) {
                     pContent.style.fontFamily = font;
                     pText.style.color = cText;
                     pRef.style.color = cRef;
                     if (isLiveVisible && projectorWindow.fitText) projectorWindow.fitText();
                 }
             }
        };

        els.fontSel.addEventListener('change', updateStylesOnly);
        els.colorText.addEventListener('input', updateStylesOnly);
        els.colorRef.addEventListener('input', updateStylesOnly);

        // --- CORE FUNCTIONS ---
        els.btnOpenProj.addEventListener('click', () => {
            if (projectorWindow && !projectorWindow.closed) { projectorWindow.focus(); return; }
            projectorWindow = window.open('', 'BibleProjector', 'width=1024,height=768,menubar=no,toolbar=no,location=no,status=no');
            const doc = projectorWindow.document;
            doc.open();
            doc.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Bible Slide Output</title>
                    <link rel="preconnect" href="https://fonts.googleapis.com">
                    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Lora:ital,wght@1,500&family=Montserrat:wght@600&family=Open+Sans:wght@600&family=Playfair+Display:wght@700&family=Roboto+Slab:wght@600&display=swap" rel="stylesheet">
                    <style>
                        body { margin: 0; background: #000; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
                        .slide-container { width: 100%; aspect-ratio: 16 / 9; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
                        #p-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
                        #p-content { position: relative; z-index: 2; width: 60%; height: 60%; text-align: center; display: none; flex-direction: column; justify-content: center; align-items: center; text-shadow: 2px 2px 5px rgba(0,0,0,0.9); }
                        #p-ref { font-weight: 400; font-size: 5vh; flex-shrink: 0; margin-bottom: 3vh; line-height: 1.2; }
                        #p-text { font-weight: 600; line-height: 1.3; font-size: 60px; flex-grow: 0; width: 100%; }
                        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
                        @keyframes zoomIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
                        @keyframes zoomOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(1.2); } }
                        @keyframes slideUpIn { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
                        @keyframes slideDownOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(50px); } }
                        @keyframes blurIn { from { opacity: 0; filter: blur(10px); } to { opacity: 1; filter: blur(0); } }
                        @keyframes blurOut { from { opacity: 1; filter: blur(0); } to { opacity: 0; filter: blur(10px); } }
                        .anim-fade-in { animation: fadeIn 0.8s ease forwards; }
                        .anim-fade-out { animation: fadeOut 0.6s ease forwards; }
                        .anim-zoom-in { animation: zoomIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
                        .anim-zoom-out { animation: zoomOut 0.5s ease forwards; }
                        .anim-slide-in { animation: slideUpIn 0.6s ease-out forwards; }
                        .anim-slide-out { animation: slideDownOut 0.5s ease-in forwards; }
                        .anim-blur-in { animation: blurIn 1s ease forwards; }
                        .anim-blur-out { animation: blurOut 0.6s ease forwards; }
                        .anim-none-in { animation: none; opacity: 1; }
                        .anim-none-out { animation: none; opacity: 0; }
                    </style>
                </head>
                <body>
                    <div class="slide-container" id="p-container">
                        <img id="p-bg" src="" alt="">
                        <div id="p-content">
                            <div id="p-ref"></div>
                            <div id="p-text"></div>
                        </div>
                    </div>
                    <script>
                        function fitText() {
                            const content = document.getElementById('p-content');
                            const text = document.getElementById('p-text');
                            if (content.style.display === 'none') return;
                            let fontSize = 150; text.style.fontSize = fontSize + 'px';
                            while ((content.scrollHeight > content.clientHeight || content.scrollWidth > content.clientWidth) && fontSize > 20) {
                                fontSize -= 4; text.style.fontSize = fontSize + 'px';
                            }
                        }
                        window.onresize = function() { fitText(); };
                    <\/script>
                </body>
                </html>
            `);
            doc.close();
            if (bgImageUrl) {
                const pBg = doc.getElementById('p-bg');
                pBg.src = bgImageUrl;
                pBg.style.display = 'block';
            }
            updateProjectorWindow();
        });

        function processDatabase(json) {
            flatBooks = [];
            if (json.PL) flatBooks.push(...json.PL);
            if (json.PB) flatBooks.push(...json.PB);
            if (flatBooks.length === 0) { alert("Database kosong."); return; }
            els.bookSel.innerHTML = '';
            flatBooks.forEach((book, idx) => {
                const opt = document.createElement('option');
                opt.value = idx; opt.textContent = book.name; els.bookSel.appendChild(opt);
            });
            els.bookSel.disabled = false; els.chapSel.disabled = false; els.verseSel.disabled = false;
            resetToGenesis();
            els.statusBar.textContent = "Database Siap: " + flatBooks.length + " Kitab.";
        }

        function resetToGenesis() {
            liveState = { bookIdx: 0, chIdx: 0, vIdx: 0 };
            selectedState = { bookIdx: 0, chIdx: 0, vIdx: 0 };
            isLiveVisible = false;
            updateDropdownsFromSelection();
            updatePreviewPanels();
        }

        function getBook(idx) { return flatBooks[idx]; }
        function getChapter(bIdx, cIdx) { return flatBooks[bIdx]?.chapters[cIdx]; }
        function getVerse(bIdx, cIdx, vIdx) { return flatBooks[bIdx]?.chapters[cIdx]?.verses[vIdx]; }
        function formatRef(bIdx, cIdx, vIdx) {
            const b = getBook(bIdx); const c = getChapter(bIdx, cIdx); const v = getVerse(bIdx, cIdx, vIdx);
            if (!b || !c || !v) return "-";
            return `${b.name} ${c.number}:${v.number}`;
        }
        function isSameState(s1, s2) { return s1.bookIdx === s2.bookIdx && s1.chIdx === s2.chIdx && s1.vIdx === s2.vIdx; }

        function calculateNext(state) {
            const b = flatBooks[state.bookIdx]; const c = b.chapters[state.chIdx];
            if (state.vIdx < c.verses.length - 1) return { ...state, vIdx: state.vIdx + 1 };
            if (state.chIdx < b.chapters.length - 1) return { bookIdx: state.bookIdx, chIdx: state.chIdx + 1, vIdx: 0 };
            if (state.bookIdx < flatBooks.length - 1) return { bookIdx: state.bookIdx + 1, chIdx: 0, vIdx: 0 };
            return null;
        }

        function calculatePrev(state) {
            if (state.vIdx > 0) return { ...state, vIdx: state.vIdx - 1 };
            if (state.chIdx > 0) {
                const prevChIdx = state.chIdx - 1; const prevCh = flatBooks[state.bookIdx].chapters[prevChIdx];
                return { bookIdx: state.bookIdx, chIdx: prevChIdx, vIdx: prevCh.verses.length - 1 };
            }
            if (state.bookIdx > 0) {
                const prevBkIdx = state.bookIdx - 1; const prevBk = flatBooks[prevBkIdx];
                const prevChIdx = prevBk.chapters.length - 1; const prevCh = prevBk.chapters[prevChIdx];
                return { bookIdx: prevBkIdx, chIdx: prevChIdx, vIdx: prevCh.verses.length - 1 };
            }
            return null;
        }

        els.bookSel.addEventListener('change', () => { selectedState = { bookIdx: parseInt(els.bookSel.value), chIdx: 0, vIdx: 0 }; updateDropdownsFromSelection(); updatePreviewPanels(); });
        els.chapSel.addEventListener('change', () => { selectedState = { ...selectedState, chIdx: parseInt(els.chapSel.value), vIdx: 0 }; updateDropdownsFromSelection(); updatePreviewPanels(); });
        els.verseSel.addEventListener('change', () => { selectedState = { ...selectedState, vIdx: parseInt(els.verseSel.value) }; updatePreviewPanels(); });

        els.btnShow.addEventListener('click', () => { liveState = { ...selectedState }; isLiveVisible = true; updateSlide(); updatePreviewPanels(); });
        els.btnHide.addEventListener('click', () => { isLiveVisible = false; updateSlide(); });
        els.btnCancel.addEventListener('click', () => { selectedState = { ...liveState }; updateDropdownsFromSelection(); updatePreviewPanels(); });

        function handleNavigation(direction) {
            if (flatBooks.length === 0) return;
            const baseState = liveState;
            let newState = (direction === 'next') ? calculateNext(baseState) : calculatePrev(baseState);
            if (!newState) return;
            selectedState = { ...newState };
            if (isLiveVisible) { liveState = { ...newState }; updateSlide(); }
            else { liveState = { ...newState }; }
            updateDropdownsFromSelection(); updatePreviewPanels();
        }

        els.btnNext.addEventListener('click', () => handleNavigation('next'));
        els.btnPrev.addEventListener('click', () => handleNavigation('prev'));
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') handleNavigation('next');
            if (e.key === 'ArrowLeft') handleNavigation('prev');
        });

        function updateDropdownsFromSelection() {
            if (flatBooks.length === 0) return;
            els.bookSel.value = selectedState.bookIdx;
            const book = getBook(selectedState.bookIdx);
            els.chapSel.innerHTML = '';
            book.chapters.forEach((c, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = c.number; els.chapSel.appendChild(opt); });
            els.chapSel.value = selectedState.chIdx;
            const chapter = book.chapters[selectedState.chIdx];
            els.verseSel.innerHTML = '';
            chapter.verses.forEach((v, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = v.number; els.verseSel.appendChild(opt); });
            els.verseSel.value = selectedState.vIdx;
        }

        function updatePreviewPanels() {
            if (flatBooks.length === 0) return;
            const prev = calculatePrev(liveState);
            if (prev) {
                const v = getVerse(prev.bookIdx, prev.chIdx, prev.vIdx);
                els.pPrevRef.textContent = formatRef(prev.bookIdx, prev.chIdx, prev.vIdx); els.pPrevTxt.textContent = v.text; els.btnPrev.disabled = false;
            } else {
                els.pPrevRef.textContent = "AWAL"; els.pPrevTxt.textContent = "-"; els.btnPrev.disabled = true;
            }
            const currV = getVerse(liveState.bookIdx, liveState.chIdx, liveState.vIdx);
            els.pCurrRef.textContent = formatRef(liveState.bookIdx, liveState.chIdx, liveState.vIdx); els.pCurrTxt.textContent = currV.text;
            if (!isLiveVisible) { els.pCurrRef.textContent += " (HIDDEN)"; els.pCurrTxt.style.opacity = "0.5"; } else { els.pCurrTxt.style.opacity = "1"; }
            
            let nextStateToShow = (!isSameState(selectedState, liveState)) ? selectedState : calculateNext(liveState);
            if (nextStateToShow) {
                const v = getVerse(nextStateToShow.bookIdx, nextStateToShow.chIdx, nextStateToShow.vIdx);
                els.pNextRef.textContent = formatRef(nextStateToShow.bookIdx, nextStateToShow.chIdx, nextStateToShow.vIdx); els.pNextTxt.textContent = v.text; els.btnNext.disabled = false;
            } else {
                if (isSameState(liveState, selectedState)) { els.pNextRef.textContent = "AKHIR"; els.pNextTxt.textContent = "-"; els.btnNext.disabled = true; }
            }
        }

        function autoFitText(container, contentDiv, textDiv) {
            if (contentDiv.style.display === 'none') return;
            let fontSize = 100; textDiv.style.fontSize = fontSize + 'px';
            while (
                (contentDiv.scrollHeight > contentDiv.clientHeight || contentDiv.scrollWidth > contentDiv.clientWidth) 
                && fontSize > 10
            ) {
                fontSize -= 2; textDiv.style.fontSize = fontSize + 'px';
            }
        }

        function updateSlide() {
            applySlideContent(els.slideContent, els.slideText, els.slideRef);
            if (isLiveVisible) {
                els.slideContent.classList.remove(els.animInSel.value);
                autoFitText(els.internalContainer, els.slideContent, els.slideText);
                els.slideContent.classList.add(els.animInSel.value);
            }
            updateProjectorWindow();
        }

        function applySlideContent(contentEl, textEl, refEl) {
            const allAnims = [ 'anim-fade-in', 'anim-zoom-in', 'anim-slide-in', 'anim-blur-in', 'anim-none-in', 'anim-fade-out', 'anim-zoom-out', 'anim-slide-out', 'anim-blur-out', 'anim-none-out' ];
            contentEl.style.fontFamily = els.fontSel.value;
            textEl.style.color = els.colorText.value;
            refEl.style.color = els.colorRef.value;
            contentEl.classList.remove(...allAnims);
            void contentEl.offsetWidth;

            if (isLiveVisible) {
                const v = getVerse(liveState.bookIdx, liveState.chIdx, liveState.vIdx);
                textEl.textContent = v.text;
                refEl.textContent = formatRef(liveState.bookIdx, liveState.chIdx, liveState.vIdx);
                contentEl.style.display = 'flex';
                contentEl.classList.add(els.animInSel.value);
            } else {
                contentEl.classList.add(els.animOutSel.value);
            }
        }

        function updateProjectorWindow() {
            if (!projectorWindow || projectorWindow.closed) return;
            const doc = projectorWindow.document;
            const pContent = doc.getElementById('p-content');
            const pText = doc.getElementById('p-text');
            const pRef = doc.getElementById('p-ref');
            if (!pContent) return;

            applySlideContent(pContent, pText, pRef);
            if (isLiveVisible) {
                pContent.classList.remove(els.animInSel.value);
                if (projectorWindow.fitText) projectorWindow.fitText();
                pContent.classList.add(els.animInSel.value);
            }
        }
    </script>
</body>

</html>
